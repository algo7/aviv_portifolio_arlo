name: Deployment

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run
    steps:
      - name: Install PM2
        run: |
          sudo npm i -g pm2 &>/dev/null
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh/
          echo "Host moodli" > ~/.ssh/config
          echo "User algorithm" >> ~/.ssh/config
          echo "HostName 34.65.242.184" >> ~/.ssh/config
          echo "$KEYLOG" >> ~/.ssh/config
          echo "Host github.com" >> ~/.ssh/config
          echo "User algo7" >> ~/.ssh/config
          echo "IdentityFile ~/.ssh/GitKey" >> ~/.ssh/config
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/portfolio.key
          echo "$GITKEY" > ~/.ssh/GitKey
          sudo chmod 600 ~/.ssh/GitKey
          sudo chmod 600 ~/.ssh/portfolio.key
          eval "$(ssh-agent -s)" &>/dev/null
          ssh-add ~/.ssh/GitKey
          ssh -T git@github.com &>/dev/null
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{secrets.PORTFOLIO_SERVER_SSH_PRIVATE_KEY}}
          SSHCONF: ${{secrets.SSH_PROFILE}}
          GITKEY: ${{secrets.GIT_KEY}}
          KEYLOG: ${{secrets.KEY_FILE_LOCATION}}
      - name: Running Deployment Script
        run: |
          git clone git@github.com:algo7/aviv_portifolio_arlo.git
          cd aviv_portifolio_arlo
          echo "$ECOF" > ./ecosystem.json
          pm2 deploy ecosystem.json production update
        shell: bash
        env:
          ECOF: ${{secrets.ECOSYSTEM_FILE}}
